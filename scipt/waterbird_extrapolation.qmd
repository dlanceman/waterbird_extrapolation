---
title: "Waterbird extrapolation"
author: "Dana Lanceman"
format: html
editor: visual
---

## Waterbird extrapolation

Aerial waterbird surveys produce estimates of waterbird counts for wetland complexes. However, surveys cannot cover all areas of a large wetland, and survey tracks differ each year, so there is a need to standardise waterbird counts through extrapolation. Here, we demonstrate a method for extrapolating NSW aerial waterbird survey data using the Great Cumbung Swamp as an example. 

This script is run assuming that inundation rasters have already been generated for each year of the Great Cumbung Swamp.

## 1. Set up

First, let's load the packages we need for our analysis.

```{r Packages, echo = FALSE}
library(tidyverse)
library(sf)
library(readxl)
library(raster)
library(terra)
```

Next, let's set up our working directory. The path listed below in "setwd" can be replaced with whatever directory you're working in.

Let's import the datasets we need for this workflow:

-   a shapefile of the Great Cumbung Swamp, with lakes clipped out (cumbung_eco)

    -   note, this says it has 3 features because the process of clipping lakes made some parts disconnected from the rest, but we are treating this as one feature

-   an excel file of waterbird records, with named locations, for each year (wb_2010, etc)

```{r Import_boundary_waterbirds}
setwd("C:/Users/z5204897/OneDrive - UNSW/Desktop/RA/Projects/2024_Cumbung_extrapolation/waterbird_extrapolation_R/")

cumbung_eco <- st_read("data/Cumbung_ecological_minus_lakes.shp")

wb_2010 <- read_excel("data/waterbirds/2010_Cumbung_PDF-data.xlsx")
wb_2011 <- read_excel("data/waterbirds/2011_Cumbung_PDF-data.xlsx")
wb_2016 <- read_excel("data/waterbirds/2016_Cumbung_PDF-data.xlsx")
```

Import tracklogs.

-   a shapefile of the aerial survey tracklog (for NSW), for each year

    -   **note this is not currently working for geodatabases... so converted to shapefiles in QGIS. But ideally would be able to do this entire process in R**

```{r Import_tracklogs}
setwd("C:/Users/z5204897/OneDrive - UNSW/Desktop/RA/Projects/2024_Cumbung_extrapolation/waterbird_extrapolation_R/")

#st_layers("data/tracklogs/2010_EAWS2010_trklogs_2010_all.gdb")
#trk_2010_gdb <- st_read("data/tracklogs/2010_EAWS2010_trklogs_2010_all.gdb")
trk_2010_nsw <- st_read("data/tracklogs/2010_EAWS2010_trklogs_2010_all.shp")

trk_2011_nsw <- st_read("data/tracklogs/2011_EAWS2011_Logger1_all_waypoints_trklogs.gpx", layer = "tracks")

trk_2012_cumbung_C1 <- st_read("data/tracklogs/2012_C1_lines.shp")
trk_2012_cumbung_C2 <- st_read("data/tracklogs/2012_C2_lines.shp")

trk_2016_transect <- st_read("data/tracklogs/2016 - Cumbung tracklog - transects - 10-1.shp")
trk_20161109_mean <- st_read("data/tracklogs/20161109_meandering_fixed.shp")
trk_20161107_mean <- st_read("data/tracklogs/2016 - Cumbung tracklog - meander - 20161107.shp")
```

Import inundation data.

-   an inundation raster for the Great Cumbung Swamp, for each year

    -   note these are for a broader cumbung boundary and will need to be clipped to the cumbung ecological boundary

```{r Import_inun_data}
setwd("C:/Users/z5204897/OneDrive - UNSW/Desktop/RA/Projects/2024_Cumbung_extrapolation/waterbird_extrapolation_R/")

inun_2010 <- raster("data/inundation/wi_cumbung_20101203_reclass-400000_clip.tif")
inun_2011 <- raster("data/inundation/wi_cumbung_20111104_reclass-550000_clip.tif")
inun_2012 <- raster("data/inundation/wi_cumbung_20121114_reclass-300000_clip.tif")
inun_2013 <- raster("data/inundation/wi_cumbung_20131125_reclass-600000_clip.tif")
inun_2014 <- raster("data/inundation/Cumbung_inundation_20141112_SEED_clip.tif")
inun_2015 <- raster("data/inundation/Cumbung_inundation_20151115_SEED_clip.tif")
inun_2016 <- raster("data/inundation/Cumbung_inundation_20161117_SEED_clip.tif")
inun_2017 <- raster("data/inundation/wi_cumbung_20171104_reclass-670000_clip.tif")
inun_2018 <- raster("data/inundation/Cumbung_inundation_20181022_SEED_clip.tif")
inun_2019 <- raster("data/inundation/Cumbung_inundation_20191112_SEED_clip.tif")
inun_2020 <- raster("data/inundation/Cumbung_inundation_20201002_SEED_clip.tif")
inun_2021 <- raster("data/inundation/Cumbung_inundation_20211022_SEED_clip.tif")
inun_2022 <- raster("data/inundation/wi_cumbung_20221118_reclass-500000_clip.tif")
inun_2012 <- raster("data/inundation/wi_cumbung_20121114_reclass-300000_clip.tif")
```

## 2. Prepare data

Next, we need to prepare our data.

-   transform everything into the same coordinate system (GDA94 MGA zone 55, which is EPSG 28355)

```{r Transform_coords}
cumbung_eco <- st_transform(cumbung_eco, 28355)  

trk_2010_nsw <- st_transform(trk_2010_nsw, 28355)  
trk_2011_nsw <- st_transform(trk_2011_nsw, 28355)
trk_2012_cumbung_C1 <- st_transform(trk_2012_cumbung_C1, 28355)
trk_2012_cumbung_C2 <- st_transform(trk_2012_cumbung_C2, 28355)

trk_2016_transect <-  st_transform(trk_2016_transect, 28355)
#trk_20161109_mean <-  st_transform(trk_20161109_mean, 28355) # warnings
trk_20161107_mean <-  st_transform(trk_20161107_mean, 28355)

inun_2010 <- projectRaster(inun_2010, crs=28355)
inun_2011 <- projectRaster(inun_2011, crs=28355)
inun_2012 <- projectRaster(inun_2012, crs=28355)
inun_2013 <- projectRaster(inun_2012, crs=28355)
inun_2014 <- projectRaster(inun_2012, crs=28355)
inun_2015 <- projectRaster(inun_2012, crs=28355)
inun_2016 <- projectRaster(inun_2016, crs=28355)
inun_2017 <- projectRaster(inun_2012, crs=28355)
inun_2018 <- projectRaster(inun_2012, crs=28355)
inun_2019 <- projectRaster(inun_2012, crs=28355)
inun_2020 <- projectRaster(inun_2012, crs=28355)
inun_2021 <- projectRaster(inun_2012, crs=28355)
inun_2022 <- projectRaster(inun_2012, crs=28355)

# check coordinate systems are the same
ggplot() + 
  geom_sf(data = trk_2010_nsw) +
  geom_sf(data = cumbung_eco, color = "red")

plot(inun_2010)
plot(cumbung_eco, add = TRUE)
plot(trk_2016_transect, add = TRUE)
plot(trk_20161107_mean, add = TRUE)
#plot(trk_20161109_mean, add = TRUE) # not working because of the issue above

plot(inun_2012)
plot(cumbung_eco, add = TRUE)
plot(trk_2012_cumbung_C1, add = TRUE) 
plot(trk_2012_cumbung_C2, add = TRUE)

```

-   clip and buffer tracklogs

    -   clip to cumbung boundary, then separate the two tracklogs from the two different dates of flights

```{r Prepare_tracklog_data}
trk_2010_c = st_intersection(trk_2010_nsw, cumbung_eco)
plot(st_geometry(trk_2010_c))

trk_20101105_c <- trk_2010_c %>% 
  subset(name == "GPS Data Logger Bþ\u009ey 065") %>% 
  st_buffer(dist = 150)
plot(st_geometry(trk_20101105_c))

trk_20101117_c <- trk_2010_c %>% 
  subset(name == "GPS Data Logger Bþ\u009ey 079") %>% 
  st_buffer(dist = 150)
plot(st_geometry(trk_20101117_c))

trk_2011_buff <- trk_2011_nsw %>% 
  st_intersection(cumbung_eco) %>% 
  st_buffer(dist = 150)

trk_2012_C1_buff <- trk_2012_cumbung_C1 %>% 
  st_intersection(cumbung_eco) %>% 
  st_buffer(dist = 100)

trk_2012_C2_buff <- trk_2012_cumbung_C2 %>% 
  st_intersection(cumbung_eco) %>% 
  st_buffer(dist = 100)

trk_2016_transect_buff <- trk_2016_transect %>% 
  st_intersection(cumbung_eco) %>% 
  st_buffer(dist = 100)

trk_20161107_mean_buff <- trk_20161107_mean %>% 
  st_intersection(cumbung_eco) %>% 
  st_buffer(dist = 150)

plot(inun_2010)
plot(trk_20101105_c, add = TRUE)
plot(trk_20101117_c, add = TRUE)

plot(inun_2011)
plot(trk_2011_buff, add = TRUE)

plot(inun_2012)
plot(trk_2012_C1_buff, add = TRUE)
plot(trk_2012_C2_buff, add = TRUE)

plot(inun_2016)
plot(trk_2016_transect_buff, add = TRUE)
plot(trk_20161107_mean_buff, add = TRUE)
```

## 3. Spatial manipulation and proportion calculation

Now, clip the inundation rasters by the buffered tracklogs to determine the inundated area surveyed by tracklogs. Also clip inundation rasters to cumbung ecological boundary and calculate the inundated area in this total boundary. Then calculate the proportion of inundated area surveyed out of the total inundated area.

```{r Inundation_areas}
inun_prop_surveyed <- function(rasterf,tracklog){
  x <- rasterf %>% 
  crop(extent(tracklog)) %>% 
  mask(tracklog) # clip the inundation raster to the tracklog
  
  f <- as.data.frame(freq(x)) %>% subset(value == 1)
  f$area <- f$count # calculate no. cells inundated within the tracklog area
  
  y <- rasterf %>% 
  crop(extent(cumbung_eco)) %>% 
  mask(cumbung_eco) # clip the inundation raster to the cumbung boundary
  
  g <- as.data.frame(freq(y)) %>% subset(value == 1)
  g$area <- g$count # calculate no. cells inundated within the cumbung boundary
  
  print(f$area /g$area * 100) # now calculate what percentage of the total (cumbung) inundated area was surveyed within the tracklog area
}

#Prop <- inun_prop_surveyed(inun_2010, trk_20101105_c)
Prop2010 <- inun_prop_surveyed(inun_2010, trk_20101117_c)
Prop2011 <- inun_prop_surveyed(inun_2011, trk_2011_buff)
Prop2012_C1 <- inun_prop_surveyed(inun_2012, trk_2012_C1_buff)
Prop2012_C2 <- inun_prop_surveyed(inun_2012, trk_2012_C2_buff)
Prop2016 <- inun_prop_surveyed(inun_2016, trk_2016_transect_buff)
#Prop <- inun_prop_surveyed(inun_2016, trk_20161107_mean_buff)
```

## 4. Waterbird calculations

Use the proportion inundated to calculate waterbird numbers for each species for the cumbung ecological boundary. Also keep current counts for lakes. Put these all in a table with total counts for each species.

-   **Make sure these calculations use up to date datasets!**

```{r Waterbird_calculations}
wb_2010_sub <- wb_2010 %>% 
  subset(Date == "2010-11-17") %>% 
  subset(NewSubWetland == "Cumbung Swamp") %>% 
  subset(ReplicateCount == 1) 

wb_2010_summary <- wb_2010_sub %>% 
  group_by(SPP) %>% 
  summarise(sum = sum(Count)) %>% 
  mutate(extrap_count = round(sum * 100/Prop2010))

wb_2011_sub <- wb_2011 %>% 
  subset(NewSubWetland == "Cumbung Swamp") %>% 
  subset(ReplicateCount == 1) 

wb_2011_summary <- wb_2011_sub %>% 
  group_by(SPP) %>% 
  summarise(sum = sum(Count)) %>% 
  mutate(extrap_count = round(sum * 100/Prop2011))


wb_2016_sub <- wb_2016 %>% 
  subset(Date == "2016-11-09") %>% 
  subset(NewSubWetland == "Cumbung Swamp") %>% 
  filter(str_detect(PDF_wetland, "Transect")) %>% 
  subset(ReplicateCount == 1) 

wb_2016_summary <- wb_2016_sub %>% 
  group_by(SPP) %>% 
  summarise(sum = sum(Count)) %>% 
  mutate(extrap_count = round(sum * 100/Prop2016))

sum(wb_2010_summary$extrap_count)
sum(wb_2011_summary$extrap_count)
sum(wb_2016_summary$extrap_count)

#sum(wb_2011_sub$Count)
```
